
大数据电影点评系统
--

电影推荐系统（MovieLens）是美国明尼苏达大学（Minnesota）计算机科学与工程许愿的GroupLens项目组创办的，
是一个非商业性质的、以研究为目的的实验性站点。 这个项目是由John Riedl教授和Joseph Konstan教授领导的。
该项目从1992年开始研究自动化协同过滤，在1996年使用自动化系统顾虑系统应用于USENET新闻组中。 

电影推荐系统主要使用协同过滤和关联规则相结合的技术，向用户推荐他们感兴趣的电影。

[电影鬼剑系统（MovieLen）数据下载地址为](https://grouplens.org/datasets/movielens/)。
GroupLens项目研究收集了从电影鬼剑系统MovieLens站点提供评级的数据集（http://MovieLens.org）,
收集了不同时间段的数据，我们可以根据电影分析业务需求下载不同规模大小的数据源文件。

#### 数据说明
Stable benchmark dataset. 1 million ratings from 6000 users on 4000 movies. Released 2/2003.
以demo/resources-data/ml-1m数据为例，

* **ratings.dat**数据格式描述：
```
用户ID::电影ID::评分数据::时间戳
UserId::MovieId::Rating::Timestamp

1::1193::5::978300760
1::661::3::978302109
1::914::3::978301968

- 共1000209条数据

- 用户ID范围在1 ~ 6040
- 电影ID范围在 1~ 3952
- 评级：使用五行评分方式
- 时间戳表示系统记录的时间
- 每个用户至少有20个评级
```

* 用户文件**users.dat**
```
用户ID::性别::年龄::职业::邮编代码
UserID::GENDER::Age::Occupation::Zip-code
1::F::1::10::48067
2::M::56::16::70072
3::M::25::15::55117

- 所有的用户资料由用户资源提供，GroupLens项目组不会去检查用户数据的准确性。这个数据集中包含用户提供的用户数据
- 性别： "M"男性，"F"女性
- 年龄有以下范围选择：
* 1：    "小于18岁"
* 18：   "18岁年龄段：从18岁到24岁"
* 25：   "25岁年龄段：从25岁到34岁"
* 35：   "35岁年龄段：从35岁到44岁"
* 45：   "45岁年龄段：从45岁到49岁"
* 50：   "50岁年龄段：从50岁到55岁"
* 56：   "56岁年龄段：大于56岁"
```

* 用户文件**movies.dat**
```
电影ID::电影名::电影类型
MovieID::Title::Genres
1::Toy Story (1995)::Animation|Children's|Comedy
2::Jumanji (1995)::Adventure|Children's|Fantasy
3::Grumpier Old Men (1995)::Comedy|Romance

- 标题由亚马逊公司的互联网电影资料库（IMDB）提供的，包括电影发布年份
- 电影类型包括一下类型：
* Action：       动作
* Adventure：    冒险
* Animation：    动画
* Children's：   儿童
* Comedy：       喜剧
* Crime：        犯罪
* Documentary：  纪录片
* Drame:        戏剧
* Fantasy:      幻想
* Film-Noir：    黑色电影
* Horror：       恐怖
* Musical:      音乐
* Mystery:      神秘
* Romance:      浪漫
* Sci-Fi:       科幻
* Thriller:     惊悚
* War:          战争
* Western:      西方 

- 由于偶然重复的电影记录或者电影记录测试，一些电影ID和电影名可能不一致。
- 电影记录大多是GroupLens手工输入的，因此不一定准确。
```

* 职业数据说明
```
OccupationID::Occupation
职业ID::职业名

- 职业包含如下选择：
0:      "其他"或未指定
1:      "学术/教育者"
2:      "艺术家"
3:      "文书/行政"
4:      "高校毕业生"
5:      "客户服务"
6:      "医生/保健"
7:      "行政/管理"
8:      "农民"
9:      "家庭主妇"
10:     "中小学生"
11:     "律师"
12:     "程序员"
13:     "退休"
14:     "销售/市场营销"
15:     "科学家"
16:     "个体户"
17:     "技术员/工程师"
18:     "商人或工匠"
19:     "失业"
20:     "作家"
```

### 用户行为分析统计
1. 在生产环境中，企业通常使用Kafka的方式实时收集前端服务器中发送的用户行为日志记录信息。  
2. 用户行为数据过滤：可以在前端服务器端进行用户行为数据的过滤和格式化，也可以采用Spark SQL的方式进行数据过滤。

3. 用户行为统计处理：
    * 一个基本的技巧是，先使用传统的SQL去实现一个数据处理的业务逻辑；
    * 在Spark 2.x的时候，在一次推荐使用DataSet去实现业务功能，尤其是统计分析功能；
    * 如果想成为专家级别的顶级Spark人才，请使用RDD实现业务功能，   
    
用户行为分析统计的数据格式，在生产环境中，强烈建议大家使用**Parquet**文件格式。
parquet是面向分析性业务的列式存储格式，有Twitter和Cloudera合并开发，2015年5月成为Apache顶级项目。



### 通过RDD实现电影流行度分析
统计所有电影中平均得分最高（口碑最好）的电影及观看人数最多（流行度最高）的电影

1. 所有有电影中平均得分最高的Top10电影实现思路：
  如果想算总的评分，一般肯定需要reduceByKey操作或者aggregateByKey操作。
  
2. 所有电影中电影粉丝或者观看人数最多的电影实现思路：
  
  
### 12.3 通过RDD分析各种类型的最喜爱电影TopN 及性能优化技巧
通过RDD分析大数据电影点评系统各类型的最喜爱电影TopN。
这次主要分析最肉男性喜爱的电影TOP10和最受女性喜爱的电影Top10.

**注意：**在聚合处理时，尽量使用mapjoin，因为它一定不会发生数据倾斜。


### 12.4 通过RDD分析电影点评系统仿QQ和微信等用户群分析及广播背后机制解密
分析最受不同年龄段人员欢迎的电影TopN

* 如何对不同年龄段进行界定
一般情况下，我们都是在原始数据中直接对要进行分组的年龄段提前进行数据清洗ETL，例如清洗ETL后产生以下数据：
```
* 1：    "小于18岁"
* 18：   "18岁年龄段：从18岁到24岁"
* 25：   "25岁年龄段：从25岁到34岁"
* 35：   "35岁年龄段：从35岁到44岁"
* 45：   "45岁年龄段：从45岁到49岁"
* 50：   "50岁年龄段：从50岁到55岁"
* 56：   "56岁年龄段：大于56岁"
```
 ①在现实的时候可以使用RDD的filter算子，但这样做会导致运行时大量计算，因为要进行扫描，所以非常耗性能，
 通过提前进行数据清洗ETL把计算发生在Spark的业务逻辑运行前，用空间换时间。  
 
 ②这里要使用mapjoin，原因是targetUsers数据只有UserID，数据量一般不会太大，(用户ID，((用户ID, 性别， 年龄), 职业名))。
 在Spark中如何实现mapjoin呢？显然是要借助于Broadcast，吧数据广播到Executor级别，让改Executor上的所有任务共享唯一的数据，
 而不是每次运行Task的时候都发送一份数据的复制，这样显著降低了网络数据的传输和JVM内存的消耗。
 
* 放QQ和微信等用户群的构建
 ① 过滤出年龄段为18岁年龄段（18岁到24岁）的用户，然后构建Broadcast数据结构类型的targetQQUsersBroadcast广播变量。
 ② 过滤出年龄段为25岁年龄段（25岁到34岁）的用户，然后构建Broadcast数据结构类型的targetTaobaoUsersBroadcast广播变量。
 

### 12.5 通过RDD分析电影点评系统实现Java和Scala版本 二次排序


### 12.6通过Spark SQL中的SQL语句实现电影点评系统用户行为分析
通过DataFrame实现某特定电影观看者中男性和女性不同年龄分别有多少人？

### 12.7 通过Spark SQL下的两种不同方式实现口碑最佳电影分析
Spark SQL下有两种不同方式
* 方式一：  
通过DataFrame和RDD结合的方法

* 方式二：  
通过纯粹使用DataFrame方式计算

### 12.8 通过Spark SQL下的两种不同方式实现最流行电影分析
所有电影中国粉丝或观看人数最多的电影TopN  
* Spark SQL：通过DataFrame和RDD相结合的方式
* Spark SQL:通过纯粹的使用DataFrame方式计算


### 12.9 通过DataFrame分析最受男性和女性喜爱电影TopN

### 12.10 通过DataFrame分析电影点评系统仿QQ和微信等用户群


### 12.11 纯粹通过DataSet对电影点评系统进行流行度和不同年龄阶段兴趣分析等


### 12.12 大数据电影点评系统应用案例涉及的核心知识原理、源码及案例代码
广播变量是用来广播的变量，允许Spark应用程序获取一个只读的变量，
只读的变量缓存到每个分布式节点上，而不是给每个任务传送它的一份数据副本。
Spark可以高效的方式给每个节点复制一个大的输入数据集，使用高效广播算法分发广播变量，从而减少网络通信成本。  

```scala
// 创建方式
val targetQQUsersBroadcast = sc.broadcast(targetQQUuserSet)

val broacadcastVal = org.apache.spark.SparkContext.broadcast(Array(1, 2, 3))

// 获取值
broacadcastVal.value

```
 
